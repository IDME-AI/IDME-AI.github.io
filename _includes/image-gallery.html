<!-- 在<head>或这里引入二维码库 -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
    /* 你原来的样式省略，这里只示范新增部分 */

    .share-btn {
        margin-top: 10px;
        padding: 4px 10px;
        background-color: #09bb07;
        color: white;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        user-select: none;
        display: inline-block;
    }

    /* 二维码弹窗 */
    #qrcode-popup {
        position: fixed;
        z-index: 10000;
        display: none;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 0 25px rgba(0,0,0,0.6);
        text-align: center;
    }
    #qrcode-popup h3 {
        margin-bottom: 12px;
        font-weight: 700;
    }
    #qrcode {
        margin-bottom: 15px;
    }
    #qrcode-close {
        cursor: pointer;
        color: #007acc;
        font-weight: 700;
        user-select: none;
    }
</style>

<!-- 现有代码保持不变 -->

<div class="gallery-list" id="gallery"></div>

<!-- Lightbox 这里保持不变 -->

<!-- 新增二维码弹窗 -->
<div id="qrcode-popup">
    <h3>微信扫码分享</h3>
    <div id="qrcode"></div>
    <div id="qrcode-close">关闭</div>
</div>

<script>
    const galleryImages = {{ include.data | jsonify }};
    const tagButtonsContainer = document.getElementById("tag-buttons");
    const gallery = document.getElementById("gallery");
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const lightboxDesc = document.getElementById("lightbox-desc");
    const qrcodePopup = document.getElementById("qrcode-popup");
    const qrcodeContainer = document.getElementById("qrcode");
    const qrcodeClose = document.getElementById("qrcode-close");

    let currentTag = "全部";
    const allTags = Array.from(new Set(galleryImages.flatMap(img => img.tags)));

    function renderButtons() {
        const tags = ["全部", ...allTags];
        tagButtonsContainer.innerHTML = "";
        tags.forEach(tag => {
            const button = document.createElement("button");
            button.innerText = tag;
            button.className = (tag === currentTag) ? "active" : "";
            button.onclick = () => {
                currentTag = tag;
                renderButtons();
                renderGallery();
            };
            tagButtonsContainer.appendChild(button);
        });
    }

    function renderGallery() {
        gallery.innerHTML = "";
        galleryImages
            .filter(img => currentTag === "全部" || img.tags.includes(currentTag))
            .forEach(img => {
                const item = document.createElement("div");
                item.className = "gallery-item";

                // 构造分享链接，这里用当前页面URL加图片标题做锚点
                const pageUrl = window.location.origin + window.location.pathname + "#" + encodeURIComponent(img.title);

                item.onclick = () => openLightbox(img.src, img.description || "");
                item.innerHTML = `
          <div class="thumb-wrapper">
            <img src="${img.src}" alt="${img.title}" />
          </div>
          <div class="gallery-info">
            <div class="gallery-title">${img.title}</div>
            <div class="gallery-tags">${img.tags.map(t => `<span>${t}</span>`).join('')}</div>
            <div class="gallery-desc">${img.description || ''}</div>
            <div class="share-btn" onclick="event.stopPropagation(); showQrcode('${pageUrl}')">分享到微信</div>
          </div>
        `;
                gallery.appendChild(item);
            });
    }

    function openLightbox(src, desc) {
        lightbox.style.display = "flex";
        lightboxImg.src = src;
        lightboxDesc.innerHTML = desc;
    }

    // 弹出二维码生成
    function showQrcode(url) {
        qrcodeContainer.innerHTML = ""; // 清空旧二维码
        QRCode.toCanvas(qrcodeContainer, url, { width: 180 }, function (error) {
            if (error) console.error(error);
        });
        qrcodePopup.style.display = "block";
    }

    qrcodeClose.onclick = () => {
        qrcodePopup.style.display = "none";
    };

    // 点击弹窗外关闭
    window.onclick = e => {
        if (e.target === qrcodePopup) {
            qrcodePopup.style.display = "none";
        }
    };

    renderButtons();
    renderGallery();
</script>
